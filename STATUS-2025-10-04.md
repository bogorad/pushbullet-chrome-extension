# Pushbullet Chrome Extension - Development Status

## Current Mission: Add MMS Image Preview Support

**Date:** 2025-10-04
**Priority:** HIGH
**Status:** ✅ COMPLETE

### Problem Statement
MMS messages (sms_changed type with image_url) don't show image previews in notifications. They only show text, missing the visual component that makes MMS meaningful. Additionally, the notification function is complex and could be simplified with a cleaner structure.

### Root Cause
The `showPushNotification` function doesn't use Chrome's "image" notification type for MMS messages. The sms_changed handler only creates basic text notifications, ignoring the image_url property that contains the MMS image.

### Solution Plan
Completely rewrite showPushNotification with:
1. **baseOptions pattern:** Cleaner code structure with shared options
2. **MMS image preview:** Detect sms_changed with image_url and use "image" notification type
3. **Simplified logic:** Remove redundant code and variables
4. **Verify filter:** Ensure filter is correct (already is)
5. Bump version in manifest.json

---

## Task Checklist

### Phase 1: Fix Push Filter ✅
- [x] 1.1. Verify current filter in src/app/api/client.ts
- [x] 1.2. Confirm filter is correct (already has hasContent check with all properties)

### Phase 2: Rewrite Notification Function ✅
- [x] 2.1. Replace entire showPushNotification function
- [x] 2.2. Add MMS image preview support (sms_changed with image_url)
- [x] 2.3. Restructure with baseOptions pattern

### Phase 3: Version Management ✅
- [x] 3.1. Read current version from manifest.json (was 1.1.30)
- [x] 3.2. Bump minor version to 1.1.31
- [x] 3.3. Update manifest.json with new version

### Phase 4: Documentation ✅
- [x] 4.1. Update STATUS.md with MMS image preview feature
- [x] 4.2. Review all changes
- [x] 4.3. Verify no regressions

---

## Previous Fixes Applied

### Fix 1: State Machine Hydration (Completed)
- **Problem:** State machine lost state across service worker restarts
- **Solution:** Implemented state persistence and hydration via chrome.storage
- **Files Modified:** `src/background/state-machine.ts`, `src/background/index.ts`
- **Version:** 1.1.15

### Fix 2: Device Nickname Update (Completed)
- **Problem:** Message action name mismatch between options page and background script
- **Solution:** Fixed message protocol to use correct action name and property
- **Files Modified:** `src/options/index.ts`, `src/background/index.ts`
- **Version:** 1.1.16

### Fix 3: Storage Race Condition (Completed)
- **Problem:** chrome.storage API unavailable immediately after service worker restart
- **Solution:** Implemented retry mechanism with `getApiKeyWithRetries()`
- **Files Modified:** `src/background/index.ts`
- **Version:** 1.1.17

### Fix 4: sendPush Handler Hardening (Completed) ✅ VALIDATED
- **Problem:** sendPush handler failed after service worker restart due to reading from in-memory state
- **Solution:** Added `ensureConfigLoaded()` call at beginning of handler to reload state from storage
- **Files Modified:** `src/background/index.ts`, `manifest.json`
- **Version:** 1.1.18
- **Validation:** User confirmed this fix addresses the exact bug observed in production logs where push sending failed with "Not logged in" error after service worker suspension. The log showed the state machine in `idle` state while WebSocket reported `Connected`, confirming the service worker had amnesia and the fix was necessary.

### Fix 5: Remove Unnecessary source_device_iden Parameter (Completed) ✅
- **Problem:** Push sending from popup was failing because unnecessary `source_device_iden` parameter was being sent to API
- **Solution:** Removed code block that adds `source_device_iden` to outgoing pushes from popup
- **Files Modified:** `src/popup/index.ts`, `manifest.json`
- **Version:** 1.1.20
- **Rationale:** The `source_device_iden` parameter is documented as optional and intended for reply scenarios ("useful when you need to send a push back to the sending device"). Including it in general push sending was unnecessary and potentially causing API rejections.

### Fix 6: Remove Faulty Authentication Check in Popup (Completed) ✅ CRITICAL
- **Problem:** Push sending from popup was failing silently because `if (!apiKey) return;` check used a module-level variable that was never re-populated when popup reopened
- **Solution:**
  1. Removed the faulty `if (!apiKey) return;` check from sendPush function
  2. Fixed file upload code to get API key from storage instead of using module-level variable
  3. Let background script handle authentication validation for all push types
- **Files Modified:** `src/popup/index.ts`, `manifest.json`
- **Version:** 1.1.21
- **Root Cause:** The popup's `apiKey` variable was only set when user saved their API key, not when popup reopened. This caused silent failures even though user was logged in.
- **Impact:** This was the actual root cause of push sending failures. The background script already has proper authentication validation with `ensureConfigLoaded()`, making the popup's check redundant and broken.

### Fix 7: Enhance sendPush Function with Comprehensive Logging (Completed) ✅
- **Problem:** sendPush function was failing silently with no visibility into execution flow or failure points
- **Solution:** Added comprehensive logging throughout the function:
  1. Entry logging to confirm function is called
  2. Log currentPushType value immediately to verify state
  3. Logging for each push type branch (note, link, file)
  4. Warning logs for all early exit points with reasons
  5. Enhanced existing logs with more context
  6. Improved error handling to log full error objects
- **Files Modified:** `src/popup/index.ts`, `manifest.json`
- **Version:** 1.1.22
- **Logging Added:**
  - Function entry: `[sendPush] Function initiated.`
  - State verification: `[sendPush] currentPushType is: '...'`
  - Branch logging: `[sendPush] Handling "note/link/file" type.`
  - Exit warnings: `[sendPush] Exiting: ...` (with specific reason)
  - Validation passed: `[sendPush] Validation passed. Preparing to send message...`
  - Response logging: `[sendPush] Received response from background script:`
  - Error logging: `[sendPush] Error sending message to background:` / `[sendPush] An unexpected error occurred...`
- **Impact:** Provides complete visibility into function execution flow, making it easy to identify where and why the function fails. All logs are prefixed with `[sendPush]` for easy filtering in the popup's developer console.

### Fix 8: Centralize Popup Logging Through Background Script (Completed) ✅
- **Problem:** Logs were split between popup's console and background script's debugLogger, making debugging difficult and preventing log persistence
- **Solution:** Centralized all popup logging through the background script's debugLogger:
  1. Created `logToBackground` utility function in popup with fallback error handling
  2. Implemented log message handler in background script with `[POPUP]` prefix
  3. Refactored `sendPush` to replace all console.log/warn/error with logToBackground
  4. Removed noisy DEBUG logs from background script's message listener and getDebugSummary handler
- **Files Modified:** `src/popup/index.ts`, `src/background/index.ts`, `manifest.json`
- **Version:** 1.1.23
- **Architecture Changes:**
  - Popup now sends log messages to background via `chrome.runtime.sendMessage({ action: 'log', payload: { level, message, data } })`
  - Background handler routes logs to debugLogger with `[POPUP]` prefix for source identification
  - Fallback to console logging if background is unavailable (with `[FALLBACK]` prefix)
  - INFO fallbacks are silent to avoid noise during service worker wake-up
- **Impact:** Single, centralized location (Debug Dashboard) for viewing all extension logs. Logs are now persisted and available even after popup closes. Cleaner debugging experience with all logs in one place.

### Fix 9: Implement Missing Auto-Open Links Functionality (Completed) ✅
- **Problem:** Auto-open links functionality was missing - setting existed in options but had no implementation
- **Solution:** Implemented auto-open logic in push reception handler:
  1. Added check for autoOpenLinks setting after notification is shown
  2. Used isLinkPush type guard to filter for link-type pushes
  3. Opens links in new tabs using chrome.tabs.create with active: false (background)
  4. Added comprehensive logging for debugging
  5. Includes error handling for failed tab creation
- **Files Modified:** `src/background/index.ts`, `manifest.json`
- **Version:** 1.1.24
- **Implementation Details:**
  - Location: Push reception handler (websocket:push event, line 339-355)
  - Checks: `autoOpenLinks && isLinkPush(decryptedPush)`
  - Opens in background to avoid disrupting user workflow
  - Logs both successful opens and failures
- **Impact:** The auto-open links setting in options is now functional. When enabled, link pushes automatically open in new browser tabs, improving user workflow and making the feature work as expected.

### Fix 10: Fix Auto-Open Links for Tickle Mechanism (Completed) ✅
- **Problem:** Auto-open links only worked for real-time pushes (websocket:push) but not for tickle-based pushes (refreshPushes)
- **Solution:** Added auto-open logic to the refreshPushes function:
  1. Imported LinkPush type and isLinkPush type guard from domain types
  2. Imported getAutoOpenLinks from state
  3. Added auto-open logic after showPushNotification in the for loop
  4. Used correct variable name (push instead of decryptedPush)
  5. Added LinkPush type assertion to access url property
  6. Updated log messages with "from tickle" for debugging
- **Files Modified:** `src/background/utils.ts`, `manifest.json`
- **Version:** 1.1.25
- **Implementation Details:**
  - Location: refreshPushes function in src/background/utils.ts (lines 157-173)
  - Checks: `autoOpenLinks && isLinkPush(push)`
  - Opens in background to avoid disrupting user workflow
  - Logs both successful opens and failures with "from tickle" identifier
- **Impact:** Auto-open links now works consistently regardless of how pushes are received (real-time or tickle). Users get predictable behavior where all link pushes open automatically when the setting is enabled.

### Fix 11: Guard All Entry Points Against Race Conditions (Completed) ✅
- **Problem:** Race condition where external events could trigger code before configuration loaded from storage, causing features to use default values instead of user settings
- **Solution:** Added `await ensureConfigLoaded()` guards to all entry points:
  1. **websocket:push handler** - Added guard at start of handler (line 287)
  2. **Context menu handler** - Made async and added guard (line 568)
  3. **Message handler actions:**
     - Created ACTIONS_REQUIRING_CONFIG set (line 621)
     - Added guard to getSessionData (line 673)
     - Added guard to refreshSession (wrapped in async IIFE, line 781)
     - Added guard to updateDeviceNickname (wrapped in async IIFE, line 868)
  4. **refreshPushes function** - Already guarded in previous fix (line 133 in utils.ts)
- **Files Modified:** `src/background/index.ts`, `manifest.json`
- **Version:** 1.1.27
- **Implementation Details:**
  - All guards call ensureConfigLoaded with full state setters and getters
  - Message handler actions wrapped in async IIFEs where needed
  - Context menu handler made async to support await
  - Guards ensure configuration is loaded before any processing
- **Impact:** Eliminates race conditions across all entry points. Features like auto-open links now work reliably even when events arrive immediately after extension start/reload. Significantly improves extension stability and reliability.

### Fix 12: Fix Critical Typo in ensureConfigLoaded Calls (Completed) ✅
- **Problem:** All race condition guards were non-functional due to incorrect function call syntax - `ensureConfigLoaded()` was called with arguments when it should be called with none
- **Solution:** Fixed all 7 incorrect calls to use correct no-argument syntax:
  1. **src/background/index.ts** (6 fixes):
     - websocket:push handler (line 286)
     - Context menu handler (line 555)
     - getSessionData (line 644)
     - refreshSession (line 739)
     - updateDeviceNickname (line 811)
     - sendPush (line 985)
  2. **src/background/utils.ts** (1 fix):
     - refreshPushes function (line 137)
- **Files Modified:** `src/background/index.ts`, `src/background/utils.ts`, `manifest.json`
- **Version:** 1.1.28
- **Implementation Details:**
  - Changed from: `await ensureConfigLoaded({ setApiKey, ... }, { getApiKey, ... })`
  - Changed to: `await ensureConfigLoaded()`
  - Function now correctly loads all settings from storage into memory
  - All race condition guards now functional
- **Impact:** Race condition guards now actually work. Configuration is correctly loaded before processing any external events. Features like auto-open links now reliably use user settings instead of defaults, even when events arrive immediately after extension start/reload.

### Fix 13: Add Encrypted Push Handling and Full File Push Support (Completed) ✅
- **Problem:** Two UX issues: (1) Encrypted pushes without password showed blank notifications, (2) File pushes were filtered out and didn't show notifications
- **Solution:** Implemented both features:
  1. **Encrypted Push Handling:**
     - Added check at start of showPushNotification for `encrypted && ciphertext`
     - Shows helpful notification: "An encrypted push was received. To view future encrypted pushes you need to add the correct end2end password in options"
     - Returns early to avoid showing blank notification
  2. **File Push Support:**
     - Updated filter in src/app/api/client.ts to include `file_name` and `file_url` in hasContent check
     - Updated file notification format to "New File: {filename}" with body or file_type as message
     - Files now appear in history and show proper notifications
- **Files Modified:** `src/background/utils.ts`, `src/app/api/client.ts`, `manifest.json`
- **Version:** 1.1.29
- **Implementation Details:**
  - Encrypted push check: `if (push.encrypted && 'ciphertext' in push)` at line 213 in utils.ts
  - Filter update: Added `|| ('file_name' in push && push.file_name) || ('file_url' in push && push.file_url)` at line 119-120 in client.ts
  - File notification: `title = 'New File: ${push.file_name || 'unknown file'}'; message = push.body || push.file_type || '';` at line 250-251 in utils.ts
- **Impact:** Significantly improved UX. Users now get helpful instructions for encrypted pushes instead of confusion. File pushes are fully supported with proper notifications and history display, completing the push type support.

### Fix 14: Fix File and MMS Push Handling (Completed) ✅
- **Problem:** Notification handler didn't properly distinguish between MMS messages (file pushes with title) and regular file pushes, showing incorrect notifications for MMS
- **Solution:** Replaced notification logic with robust version:
  1. **MMS Detection:** Checks if file push has a title property
  2. **MMS Handling:** Uses title directly (e.g., "MMS from John") with body or "Image ({file_type})" as message
  3. **Regular Files:** Uses "New File: {filename}" format with body or file_type as message
  4. **Filter Verification:** Confirmed filter already correct with hasContent check including file_name and file_url
- **Files Modified:** `src/background/utils.ts`, `manifest.json`
- **Version:** 1.1.30
- **Implementation Details:**
  - File handling at lines 247-257 in utils.ts
  - Checks `if (push.title)` to detect MMS
  - MMS: `title = push.title; message = push.body || 'Image (${push.file_type})';`
  - Regular files: `title = 'New File: ${push.file_name || 'unknown file'}'; message = push.body || push.file_type || '';`
  - Simplified logic by removing redundant pushType variable
- **Impact:** MMS messages now show proper notifications with sender information instead of generic "New File" messages. Regular file pushes continue to work correctly. Complete and correct handling of all file-based push types.

### Fix 15: Add MMS Image Preview Support (Completed) ✅
- **Problem:** MMS messages (sms_changed type) didn't show image previews in notifications, only text
- **Solution:** Completely rewrote showPushNotification function:
  1. **baseOptions Pattern:** Introduced cleaner code structure with shared notification options
  2. **MMS Image Preview:** Added detection for sms_changed with image_url, uses Chrome's "image" notification type
  3. **Simplified Logic:** Removed redundant variables and code paths
  4. **Three-tier Handler:**
     - Encrypted pushes: Show helpful message
     - MMS with image: Use "image" type notification with imageUrl
     - Standard pushes: Use "basic" type for note, link, file
  5. **Filter Verification:** Confirmed filter already correct
- **Files Modified:** `src/background/utils.ts`, `manifest.json`
- **Version:** 1.1.31
- **Implementation Details:**
  - Added counter variable for notification IDs at line 210
  - Complete function rewrite at lines 215-287
  - baseOptions: `{ iconUrl: chrome.runtime.getURL('icons/icon128.png') }`
  - MMS detection: `push.type === 'sms_changed' && push.notifications && push.notifications.length > 0`
  - Image notification: `type: 'image', imageUrl: mms.image_url || ''`
  - Removed createNotificationWithTimeout wrapper, uses direct chrome.notifications.create
  - Simplified error handling
- **Impact:** MMS messages now show actual image previews in notifications, providing complete visual context. Code is cleaner and more maintainable with the baseOptions pattern. All push types continue to work correctly with improved structure.

---

## Notes
- All entry points that can wake the service worker must ensure core config is loaded
- **CRITICAL:** Always call `ensureConfigLoaded()` with NO arguments - it's designed to work without parameters
- Always bump version after any change, however small
- To debug popup issues, check the Debug Dashboard instead of popup console - all logs now centralized there with `[POPUP]` prefix
- Auto-open links feature respects user setting and only opens link-type pushes
- Auto-open links now works for both real-time (websocket:push) and tickle-based (refreshPushes) delivery mechanisms
- Race condition protection is now comprehensive and functional across all entry points
- Encrypted pushes now show helpful message instead of blank notification
- File pushes are now fully supported (history + notifications)
- MMS messages are properly detected and show sender information
- **MMS images now show as previews in notifications using Chrome's "image" notification type**

